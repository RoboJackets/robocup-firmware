<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>GT RoboCup SSL: Flashing code to the mtrain</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="rj_logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">GT RoboCup SSL
   </div>
   <div id="projectbrief">Soccer software, robot firmware</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('md_doc_m_train_flashing_and_debugging.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Flashing code to the mtrain </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2>Intro</h2>
<p>The mTrain on boot runs the user program located at the predetermined memory address 0x0800000 We flash code to this address using the J-Link in-order to be executed.</p>
<h2>Installing J-Link Software</h2>
<p>The J-Link software can be downloaded at: <a href="https://www.segger.com/downloads/jlink/#J-LinkSoftwareAndDocumentationPack">https://www.segger.com/downloads/jlink/#J-LinkSoftwareAndDocumentationPack</a> For Ubuntu you want to download the file labeled as 'J-Link Software and Documentation pack for Linux, DEB installer, 64-bit'</p>
<p>Provided that file was stored in your downloads folder you can use the below to install the package: </p><div class="fragment"><div class="line">sudo dpkg -i ~/Downloads/JLink_Linux_V656a_x86_64.deb</div><div class="line">sudo apt install -f</div></div><!-- fragment --><p>NOTE The name of the exact file may be slightly different depending on what version you downloaded so copying and pasting the above may not work.</p>
<p>After installing the J-Link software package please restart your terminal emulator and try to tab complete and open the program JLinkExe. If you are successful you will be greeted by the following:</p>
<div class="fragment"><div class="line">SEGGER J-Link Commander V6.56 (Compiled Nov 22 2019 17:14:15)</div><div class="line">DLL version V6.56, compiled Nov 22 2019 17:14:02</div></div><!-- fragment --><p>Followed by a can not connect error if the J-Link is not connected. Close JLinkExe with exit.</p>
<h2>Setup The JLink Unit</h2>
<p>Plug in the JLink unit to a usb port on your computer Attach the ARM-JTAG-20-10 connector to the 20 pin connector side of the J-Link unit.</p>
<p>Attach the smaller 10 pin connector to the 10 pins on the top of the mTrain.</p>
<p>Plug in the mTrain mini usb connector and plug the other end to your computer. TODO attach picture here of JLink header and where it connects on the mtrain</p>
<p>The mini usb powers the mTrain if its not receiving power from the board so it should light up after this.</p>
<h2>Flashing code to the mTrain</h2>
<p>If you have not already setup robocup-firmware to build do that now (following the guide in getting started). To build it again run the following: </p><div class="fragment"><div class="line">make all</div></div><!-- fragment --><p>After building navigate to the top level of the robojackets firmware repo. Then navigate to the build location of the robocup binaries: </p><div class="fragment"><div class="line">cd robot/build/bin/</div></div><!-- fragment --><p>Run J-LinkExe </p><div class="fragment"><div class="line">JLinkExe</div></div><!-- fragment --><p>At this point you will get the same message as in the setting up jlink software section. Then you need to connect to the processor via the following command </p><div class="fragment"><div class="line">connect</div></div><!-- fragment --><p> continue hitting enter to use all the default options and you should get a wall of processor information and a message that you have connected.</p>
<p>To program the mtrain use: </p><div class="fragment"><div class="line">loadbin ./control.bin 0x08000000</div></div><!-- fragment --><p>You should now see a progress bar for erasing flash and subsequently flashing memory. After this completes your are done and can exit J-Link. Restart the mTrain with the push button on top of the module and your code should now be running.</p>
<h1>Debugging mTrain</h1>
<h2>Whats different than using GDB as usual?</h2>
<p>Using GDB for debugging with RoboCup Firmware is different than debugging a program on your computer. Normally when start up an instance of GDB, you either start it with a binary name or use file after starting along with a file path to a binary to debug. If a binary is compiled with debug symbols (eg using the -g flag on gcc) the binary will have a symbol table which stores the human readable symbol names for memory locations (variables). Of course in addition to loading the symbol table if it exist gdb also loads the program into your memory and then waits for your to issue run before executing any instructions.</p>
<p>All of the above assumes we are running the program on the same computer we are running gdb. With RoboCup firmware this is not the case. Our program is being executed by the mTrain so we want to debug the code as it runs on the mTrain, not our local system. To do this we setup a gdbserver on the J-Link itself, which will preform the functions gdb did on our local system for the program running on the mtrain (eg starting and stopping the program as it encounters certain memory addresses like breakpoints). However the binary (.bin) we flash to the robot does not contain debug symbols, only the .elf does. The gdb server running on the J-Link does not have any idea what the symbol table contains, just at what memory addresses to stop. Instead we boot a local instance of gdb with the symbol table by loading the .elf and then connect to the gdb server running on the J-Link to control GDB (issue breakpoints, print a variable's value, etc).</p>
<h2>Running GDB on the mTrain</h2>
<ol type="1">
<li>Follow the steps outlined above for flashing code to the mTrain expect running make clean before you start and running make debug instead of make all</li>
<li>Run the following to start the gdb server on the J-Link: <div class="fragment"><div class="line">JLinkGDBServer -select USB -device STM32F769NI -endian little -if JTAG -speed auto -noLocalhostOnly</div></div><!-- fragment --></li>
<li>In another terminal you will need to run the version provided with the GnuArmNoneToolchainInstaller package that was install as part of the firmware setup script, with the file to load being the control.elf we built. When run from the bin folder in ./robot/build/ this would look like: <div class="fragment"><div class="line">~/.conan/data/GnuArmNoneToolchainInstaller/0.1.0/robojackets/testing/build/&lt;user-specific-hash&gt;/7.3_Linux/gcc-arm-none-eabi-7-2018-q2-update/bin/arm-none-eabi-gdb ./control.elf</div></div><!-- fragment --> Replacing the &lt;user-specific-hash&gt; section with whatever it is your on your system. It may be easier to navigate to this directory on your system tab completing whatever you dont know from this since there should only be one folder and the use pwd and copy the path.</li>
<li>After opening GDB we connect to the gdbserver with: <div class="fragment"><div class="line">target remote localhost:2331</div></div><!-- fragment --></li>
<li>Set whatever breakpoints you would like and start executing the program with continue (not run)</li>
</ol>
<h2>Restarting the program</h2>
<p>Usually we would use run to reload the program but when using GDB server the process is slightly different(note we didnt use run to start the program either). Instead we issue the following two commands to restart the program from the beginning: </p><div class="fragment"><div class="line">monitor reset</div><div class="line">load</div></div><!-- fragment --> </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Mon Feb 3 2020 13:37:32 for GT RoboCup SSL by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
